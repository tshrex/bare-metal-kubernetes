# Bare-Metal Kubernetes Automation with Ansible

This repository contains a suite of Ansible playbooks designed to provision, configure, and maintain a production-ready Kubernetes cluster on bare-metal Ubuntu servers. Originally developed for **Kubernetes v1.17**, this version has been refactored for **Helm 3** and modern security standards.

## üèóÔ∏è Architecture & Inventory Logic

The playbooks rely on a structured `hosts` (inventory) file to manage different server responsibilities. In a bare-metal environment, distinguishing between control-plane and worker-node logic is critical.

### Host Groups Explained
* **`kubernetes`**: A "catch-all" group for every node in the cluster. Tasks here include core system updates, disabling swap, and installing the Docker runtime/Kubelet.
* **`kubemasters`**: The Control Plane node(s). These hosts run the API server and receive `kubectl` and Helm for cluster management.
* **`kubenodes`**: The worker nodes that run your application containers. They join the cluster using a token generated by the master.

---

## üöÄ Playbook Workflow

### 01. System Dependencies (`01-kube-dependencies.yml`)
Prepares the OS layer for Kubernetes:
* **Swap Management**: Automatically disables swap and comments out fstab entries to ensure Kubelet stability.
* **Runtime Installation**: Configures Docker.io and sets up the modern Kubernetes APT repositories.

### 02. Cluster Initialization (`02-kube-install.yml`)
Automates the cluster bootstrap process:
* Runs `kubeadm init` on the master with a specified Pod Network CIDR.
* Configures the `.kube/config` for cluster access.
* Deploying **Flannel CNI** for pod networking.
* **Dynamic Join**: Generates the join command on the master and passes it as a fact to worker nodes.

### 03. Modernized Helm 3 Setup (`03-helm-install.yml`)
Refactored from legacy Helm 2 architecture:
* **Tiller-less**: Removes the insecure server-side component.
* **Observability**: Automatically installs the **Prometheus Stack** into the `monitoring` namespace.

### 04. Intelligent Maintenance (`update.yml`)
A safe approach to patching infrastructure:
* Performs `apt` upgrades and checks for the `/var/run/reboot-required` flag.
* Reboots nodes only if required by a kernel or system library update.
* Waits for the connection to restore before finalizing the play.

---

## üõ†Ô∏è Usage

1. **Define your Inventory**: Create a `hosts` file:
```ini
[kubernetes:children]
kubemasters
kubenodes

[kubemasters]
master-01 ansible_host=192.168.1.10

[kubenodes]
worker-01 ansible_host=192.168.1.11
worker-02 ansible_host=192.168.1.12# Bare-Metal Kubernetes Automation with Ansible

This repository contains a suite of Ansible playbooks designed to provision, configure, and maintain a production-ready Kubernetes cluster on bare-metal Ubuntu servers. Originally developed for **Kubernetes v1.17**, this version has been refactored for **Helm 3** and modern security standards.

## üèóÔ∏è Architecture & Inventory Logic

The playbooks rely on a structured `hosts` (inventory) file to manage different server responsibilities. In a bare-metal environment, distinguishing between control-plane and worker-node logic is critical.

### Host Groups Explained
* **`kubernetes`**: A "catch-all" group for every node in the cluster. Tasks here include core system updates, disabling swap, and installing the Docker runtime/Kubelet.
* **`kubemasters`**: The Control Plane node(s). These hosts run the API server and receive `kubectl` and Helm for cluster management.
* **`kubenodes`**: The worker nodes that run your application containers. They join the cluster using a token generated by the master.

---

## üöÄ Playbook Workflow

### 01. System Dependencies (`01-kube-dependencies.yml`)
Prepares the OS layer for Kubernetes:
* **Swap Management**: Automatically disables swap and comments out fstab entries to ensure Kubelet stability.
* **Runtime Installation**: Configures Docker.io and sets up the modern Kubernetes APT repositories.

### 02. Cluster Initialization (`02-kube-install.yml`)
Automates the cluster bootstrap process:
* Runs `kubeadm init` on the master with a specified Pod Network CIDR.
* Configures the `.kube/config` for cluster access.
* Deploying **Flannel CNI** for pod networking.
* **Dynamic Join**: Generates the join command on the master and passes it as a fact to worker nodes.

### 03. Modernized Helm 3 Setup (`03-helm-install.yml`)
Refactored from legacy Helm 2 architecture:
* **Tiller-less**: Removes the insecure server-side component.
* **Observability**: Automatically installs the **Prometheus Stack** into the `monitoring` namespace.

### 04. Intelligent Maintenance (`update.yml`)
A safe approach to patching infrastructure:
* Performs `apt` upgrades and checks for the `/var/run/reboot-required` flag.
* Reboots nodes only if required by a kernel or system library update.
* Waits for the connection to restore before finalizing the play.

---

## üõ†Ô∏è Usage

1. **Define your Inventory**: Create a `hosts` file:
```ini
[kubernetes:children]
kubemasters
kubenodes

[kubemasters]
master-01 ansible_host=192.168.1.10

[kubenodes]
worker-01 ansible_host=192.168.1.11
worker-02 ansible_host=192.168.1.12
